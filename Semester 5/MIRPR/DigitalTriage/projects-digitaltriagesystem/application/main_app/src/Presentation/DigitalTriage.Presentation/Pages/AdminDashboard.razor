@page "/admin"
@attribute [Authorize(Roles="Doctor")]
@using DigitalTriage.Domain.Entities
@using DigitalTriage.Presentation.Common.Helpers
@using DigitalTriage.Application.Contracts.Services
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Linq
@inject IPatientService PatientService
@inject IHospitalService HospitalService
@inject IHttpContextAccessor HttpContextAccessor
@inject IAuthHelper Auth

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h2 class="fw-bold mb-2">
                    <i class="bi bi-speedometer2 me-2 text-success"></i>Admin Dashboard
                </h2>
                <p class="text-muted">Manage patients and monitor reported issues</p>
            </div>
        </div>
    </div>

    @if (isHospitalSectionLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading hospitals...</span>
            </div>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(hospitalLoadError))
        {
            <div class="alert alert-danger d-flex align-items-center gap-2 mb-4">
                <i class="bi bi-exclamation-triangle"></i>
                <span>@hospitalLoadError</span>
            </div>
        }
        else
        {
            <div class="alert alert-info d-flex align-items-center gap-2 mb-4">
                <i class="bi bi-info-circle text-primary"></i>
                <span>
                    Manage hospitals and memberships on the
                    <a href="/hospital-management" class="fw-semibold text-decoration-none">Hospital Management</a>
                    page. Any hospitals you join there control which patients appear below.
                </span>
            </div>
        }
    }

    @if (isPatientsLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row align-items-end mb-4">
            <div class="col-lg-4 col-md-6">
                <label class="form-label fw-semibold">Filter by hospital</label>
                <select class="form-select" value="@SelectedHospitalFilterValue" @onchange="OnHospitalFilterChanged" disabled="@(!doctorHospitals.Any())">
                    <option value="">All hospitals</option>
                    @foreach (var hospital in doctorHospitals)
                    {
                        <option value="@hospital.Id">@hospital.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-gradient bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-people fs-1"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold fs-4">@patients.Count</div>
                                <div class="small">Total Patients</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-gradient bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-clipboard-check fs-1"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold fs-4">@patients.Sum(p => p.Issues?.Count() ?? 0)</div>
                                <div class="small">Reported Issues</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-gradient bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-calendar-event fs-1"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold fs-4">@patients.Count(p => p.MedicalDatas?.Any() == true)</div>
                                <div class="small">With Records</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm bg-gradient bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-heart-pulse fs-1"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold fs-4">@patients.Count(p => p.MedicalDatas?.Any(m => m.LastVisitDate >= DateTime.Now.AddMonths(-3)) == true)</div>
                                <div class="small">Recent Visits</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!patients.Any())
        {
            <div class="alert alert-light border">
                <i class="bi bi-info-circle me-2"></i>No patients available for the selected hospital(s).
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var p in patients)
                {
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm border-0 h-100 patient-card" style="cursor: pointer;" @onclick="() => OpenPatientModal(p)">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                        <i class="bi bi-person fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-1">@p.FirstName @p.LastName</h5>
                                        <p class="card-subtitle text-muted mb-0">
                                            <i class="bi bi-envelope me-1"></i>@p.Email
                                        </p>
                                    </div>
                                </div>
                                
                                @if(p.MedicalDatas?.OrderByDescending(m=>m.LastVisitDate).FirstOrDefault()?.LastVisitDate != null)
                                {
                                    <div class="alert alert-light mb-3">
                                        <i class="bi bi-calendar-check me-2"></i>
                                        <strong>Last Visit:</strong> @p.MedicalDatas?.OrderByDescending(m=>m.LastVisitDate).FirstOrDefault()?.LastVisitDate?.ToString("MMM dd, yyyy")
                                    </div>
                                }
                                
                                <hr />
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-list-check me-2 text-success"></i>Reported Issues (@p.Issues?.Count() ?? 0)
                                </h6>
                                
                                @if(p.Issues?.Any() == true)
                                {
                                    foreach(var i in p.Issues.OrderByDescending(x=>x.CreatedAt).Take(2))
                                    {
                                        <div class="card mb-2 border-start border-success border-3">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <strong class="mb-1">@i.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock me-1"></i>@i.CreatedAt.LocalDateTime.ToString("MMM dd")
                                                    </small>
                                                </div>
                                                <p class="mb-0 small text-secondary">@i.Description</p>
                                            </div>
                                        </div>
                                    }
                                    @if(p.Issues.Count() > 2)
                                    {
                                        <div class="text-muted text-center py-2">
                                            <i class="bi bi-three-dots"></i> And @(p.Issues.Count() - 2) more...
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-muted text-center py-2">
                                        <i class="bi bi-clipboard-x"></i> No issues reported
                                    </div>
                                }
                                
                                <div class="mt-3 text-center">
                                    <button class="btn btn-outline-primary btn-sm w-100" @onclick="() => OpenPatientModal(p)" @onclick:stopPropagation="true">
                                        <i class="bi bi-eye me-2"></i>View Full Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

<!-- Patient Details Modal -->
@if(selectedPatient != null)
{
    <div class="modal fade show" id="patientModal" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle me-2"></i>Patient Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="ClosePatientModal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="row">
                        <!-- Personal Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm border-primary border-2">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-person-vcard me-2 text-primary"></i>Personal Information
                                    </h6>
                                    <table class="table table-borderless mb-0">
                                        <tr>
                                            <td class="fw-semibold" width="40%">Name:</td>
                                            <td>@selectedPatient.FirstName @selectedPatient.LastName</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Email:</td>
                                            <td>@selectedPatient.Email</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Phone:</td>
                                            <td>@(selectedPatient.PhoneNumber ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">CNP:</td>
                                            <td>@(selectedPatient.Cnp ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">ID Document:</td>
                                            <td>@(selectedPatient.Serie ?? "N/A") / @(selectedPatient.Nr ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Citizenship:</td>
                                            <td>@(selectedPatient.Citizenship ?? "N/A")</td>
                                        </tr>
                                        @if(selectedPatient.PlaceOfBirth != null)
                                        {
                                            <tr>
                                                <td class="fw-semibold">Place of Birth:</td>
                                                <td>@selectedPatient.PlaceOfBirth.City, @selectedPatient.PlaceOfBirth.County, @selectedPatient.PlaceOfBirth.Country</td>
                                            </tr>
                                        }
                                        @if(selectedPatient.Domicile != null)
                                        {
                                            <tr>
                                                <td class="fw-semibold">Address:</td>
                                                <td>@selectedPatient.Domicile.Street @selectedPatient.Domicile.Number, @selectedPatient.Domicile.City, @selectedPatient.Domicile.County, @selectedPatient.Domicile.Country</td>
                                            </tr>
                                        }
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm border-danger border-2">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-heart-pulse me-2 text-danger"></i>Medical Information
                                    </h6>
                                    @foreach(var medicalData in selectedPatient.MedicalDatas)
                                    {
                                        <table class="table table-borderless mb-0">
                                            <tr>
                                                <td class="fw-semibold" width="40%">Blood Type:</td>
                                                <td>@(medicalData.BloodType ?? "N/A")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Allergies:</td>
                                                <td>@(string.IsNullOrEmpty(medicalData.Allergies) ? "None" : medicalData.Allergies)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Chronic Diseases:</td>
                                                <td>@(string.IsNullOrEmpty(medicalData.ChronicDiseases) ? "None" : medicalData.ChronicDiseases)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Current Medication:</td>
                                                <td>@(string.IsNullOrEmpty(medicalData.CurrentMedication) ? "None" : medicalData.CurrentMedication)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Symptoms:</td>
                                                <td>@(string.IsNullOrWhiteSpace(medicalData.Symptoms) ? "None" : medicalData.Symptoms)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Incident Location:</td>
                                                <td>@(medicalData.IncidentLocation ?? "N/A")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Preliminary Diagnosis:</td>
                                                <td>@(string.IsNullOrWhiteSpace(medicalData.PreliminaryDiagnosis) ? "Not provided" : medicalData.PreliminaryDiagnosis)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Personal History:</td>
                                                <td>@(string.IsNullOrWhiteSpace(medicalData.PersonalHistory) ? "Not provided" : medicalData.PersonalHistory)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Family History:</td>
                                                <td>@(string.IsNullOrWhiteSpace(medicalData.FamilyHistory) ? "Not provided" : medicalData.FamilyHistory)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Living Conditions:</td>
                                                <td>@(string.IsNullOrWhiteSpace(medicalData.LivingConditions) ? "Not provided" : medicalData.LivingConditions)</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Emergency Contact:</td>
                                                <td>@(medicalData.EmergencyContactName ?? "N/A") - @(medicalData.EmergencyContactPhone ?? "N/A")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Last Visit:</td>
                                                <td>@(medicalData.LastVisitDate?.ToString("MMM dd, yyyy") ?? "N/A")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Triage Category:</td>
                                                <td>
                                                    @if(!string.IsNullOrEmpty(medicalData.TriageCategory))
                                                    {
                                                        <span class="badge bg-warning text-dark">@medicalData.TriageCategory</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Not assigned</span>
                                                    }
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">ESI Level:</td>
                                                <td>@(medicalData.TriageLevel?.ToString() ?? "Not set")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Estimated Wait:</td>
                                                <td>@(medicalData.EstimatedWaitTimeMinutes.HasValue ? $"{medicalData.EstimatedWaitTimeMinutes} minute(s)" : "Not estimated")</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Confidential:</td>
                                                <td>
                                                    @if (medicalData.IsConfidential)
                                                    {
                                                        <span class="badge text-bg-danger"><i class="bi bi-lock-fill me-1"></i> Confidential</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge text-bg-secondary"><i class="bi bi-unlock me-1"></i> Shared</span>
                                                    }
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Authorized Doctor:</td>
                                                <td>
                                                    @if (medicalData.AuthorizedDoctor?.User != null)
                                                    {
                                                        <div>
                                                            <i class="bi bi-person-check me-1"></i>@($"{medicalData.AuthorizedDoctor.User.FirstName} {medicalData.AuthorizedDoctor.User.LastName}".Trim())
                                                        </div>
                                                        <div class="text-muted small">
                                                            @(string.IsNullOrWhiteSpace(medicalData.AuthorizedDoctor.Specialization)
                                                                ? "Specialization not set"
                                                                : medicalData.AuthorizedDoctor.Specialization)
                                                        </div>
                                                        <div class="text-muted small">
                                                            @medicalData.AuthorizedDoctor.User.Email
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No doctor assigned</span>
                                                    }
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="fw-semibold">Record Timeline:</td>
                                                <td class="text-muted small">
                                                    <div><i class="bi bi-calendar-event me-1"></i>Created: @medicalData.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</div>
                                                    <div><i class="bi bi-arrow-repeat me-1"></i>Updated: @(medicalData.UpdatedAt?.ToLocalTime().ToString("MMM dd, yyyy HH:mm") ?? "n/a")</div>
                                                </td>
                                            </tr>
                                            @if (medicalData.Files?.Any() == true)
                                            {
                                                <tr>
                                                    <td class="fw-semibold">Attachments:</td>
                                                    <td>
                                                        <ul class="list-unstyled mb-0 small">
                                                            @foreach (var file in medicalData.Files.OrderByDescending(f => f.UploadDate))
                                                            {
                                                                <li class="mb-1">
                                                                    <i class="bi bi-paperclip me-1"></i>
                                                                    <a href="@($"/api/medical-files/download/{file.Id}")" target="_blank" rel="noopener">@file.FileName</a>
                                                                    <span class="text-muted">(@file.UploadDate.ToLocalTime().ToString("MMM dd, yyyy HH:mm"))</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    }
                                    @if(!selectedPatient.MedicalDatas.Any())
                                    {
                                        <div class="text-muted text-center py-4">
                                            <i class="bi bi-inbox display-6"></i>
                                            <p class="mb-0">No medical records yet</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- All Reported Issues -->
                        <div class="col-12">
                            <div class="card shadow-sm border-success border-2">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-list-check me-2 text-success"></i>All Reported Issues (@selectedPatient.Issues?.Count() ?? 0)
                                    </h6>
                                    @if(selectedPatient.Issues?.Any() == true)
                                    {
                                        <div class="row">
                                            @foreach(var issue in selectedPatient.Issues.OrderByDescending(x=>x.CreatedAt))
                                            {
                                                <div class="col-md-6 mb-3">
                                                    <div class="card border-start border-success border-3">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <strong>@issue.Title</strong>
                                                                <small class="text-muted">
                                                                    <i class="bi bi-clock me-1"></i>@issue.CreatedAt.LocalDateTime.ToString("MMM dd, yyyy HH:mm")
                                                                </small>
                                                            </div>
                                                            <p class="mb-0 text-secondary">@issue.Description</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-muted text-center py-4">
                                            <i class="bi bi-clipboard-x display-6"></i>
                                            <p class="mb-0">No issues reported</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePatientModal">
                        <i class="bi bi-x-circle me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="ClosePatientModal"></div>
}

<style>
    .patient-card {
        transition: all 0.3s ease;
    }

    .patient-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
</style>

@code {
    private List<Patient> patients = new();
    private bool isPatientsLoading = true;
    private int? selectedHospitalId;
    private Patient? selectedPatient;

    private Patient? doctorAccount;
    private DoctorProfile? doctorProfile;
    private int? doctorUserId;
    private List<Hospital> doctorHospitals = new();
    private bool isHospitalSectionLoading = true;
    private string? hospitalLoadError;
    private string SelectedHospitalFilterValue => selectedHospitalId?.ToString() ?? string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var principal = HttpContextAccessor.HttpContext?.User ?? new ClaimsPrincipal(new ClaimsIdentity());
        doctorUserId = Auth.GetUserId(principal);

        if (doctorUserId.HasValue)
        {
            doctorAccount = await PatientService.GetByIdAsync(doctorUserId.Value);
            doctorProfile = doctorAccount?.DoctorProfile;
            await LoadDoctorHospitalsAsync();
        }
        else
        {
            hospitalLoadError = "Unable to determine the current doctor account.";
            doctorHospitals = new List<Hospital>();
            patients = new List<Patient>();
            isPatientsLoading = false;
        }

        isHospitalSectionLoading = false;
    }

    private async Task LoadDoctorHospitalsAsync()
    {
        if (!doctorUserId.HasValue)
        {
            doctorHospitals = new List<Hospital>();
            await LoadPatientsForDoctorAsync();
            return;
        }

        doctorHospitals = (await HospitalService.GetHospitalsForDoctorAsync(doctorUserId.Value)).ToList();

        if (selectedHospitalId.HasValue && doctorHospitals.All(h => h.Id != selectedHospitalId.Value))
        {
            selectedHospitalId = null;
        }

        await LoadPatientsForDoctorAsync();
    }

    private async Task LoadPatientsForDoctorAsync()
    {
        if (!doctorUserId.HasValue)
        {
            patients = new List<Patient>();
            isPatientsLoading = false;
            return;
        }

        isPatientsLoading = true;

        try
        {
            List<int> hospitalIds;

            if (doctorHospitals?.Any() != true)
            {
                hospitalIds = new List<int>();
            }
            else if (selectedHospitalId.HasValue)
            {
                hospitalIds = new List<int> { selectedHospitalId.Value };
            }
            else
            {
                hospitalIds = doctorHospitals.Select(h => h.Id).ToList();
            }

            patients = (await PatientService.GetByHospitalIdsAsync(hospitalIds)).ToList();

            if (selectedPatient != null && patients.All(p => p.Id != selectedPatient.Id))
            {
                selectedPatient = null;
            }
        }
        finally
        {
            isPatientsLoading = false;
        }
    }

    private async Task OnHospitalFilterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(value))
        {
            selectedHospitalId = null;
        }
        else if (int.TryParse(value, out var id))
        {
            selectedHospitalId = id;
        }
        else
        {
            selectedHospitalId = null;
        }

        await LoadPatientsForDoctorAsync();
    }

    private void OpenPatientModal(Patient patient)
    {
        selectedPatient = patient;
    }

    private void ClosePatientModal()
    {
        selectedPatient = null;
    }
}
