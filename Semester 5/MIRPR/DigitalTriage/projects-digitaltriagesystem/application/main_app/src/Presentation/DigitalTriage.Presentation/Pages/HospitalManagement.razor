@page "/hospital-management"
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Linq
@using DigitalTriage.Domain.Entities
@using DigitalTriage.Application.Contracts.Services
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles="Doctor")]
@inject IHospitalService HospitalService
@inject IPatientService PatientService
@inject IAuthHelper Auth
@inject IHttpContextAccessor HttpContextAccessor

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h2 class="fw-bold mb-2">
                    <i class="bi bi-hospital me-2 text-primary"></i>Hospital Management
                </h2>
                <p class="text-muted">Create, edit, or join hospitals. Membership controls which patients you see elsewhere in the dashboard.</p>
            </div>
        </div>
    </div>

    @if (isHospitalSectionLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!doctorUserId.HasValue)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Unable to identify the current doctor account.
        </div>
    }
    else
    {
        <div class="row gy-4">
            <div class="col-lg-6">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-pencil-square me-2 text-primary"></i>@(hospitalForm.IsEdit ? "Update Hospital" : "Create Hospital")
                                </h5>
                                <p class="text-muted small mb-0">
                                    Fill in the hospital details, then choose to join it manually from the list.
                                </p>
                            </div>
                            @if (doctorProfile != null)
                            {
                                <span class="badge text-bg-primary">Specialization: @doctorProfile.Specialization</span>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(hospitalFormMessage))
                        {
                            <div class="alert alert-success py-2 mb-3">
                                <i class="bi bi-check-circle me-2"></i>@hospitalFormMessage
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(hospitalFormError))
                        {
                            <div class="alert alert-danger py-2 mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>@hospitalFormError
                            </div>
                        }

                        <EditForm Model="hospitalForm" OnValidSubmit="SaveHospital">
                            <AntiforgeryToken />
                            <DataAnnotationsValidator />

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Hospital Name</label>
                                <InputText class="form-control" @bind-Value="hospitalForm.Name" />
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Country</label>
                                    <InputText class="form-control" @bind-Value="hospitalForm.Country" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">County</label>
                                    <InputText class="form-control" @bind-Value="hospitalForm.County" />
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">City</label>
                                    <InputText class="form-control" @bind-Value="hospitalForm.City" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Street</label>
                                    <InputText class="form-control" @bind-Value="hospitalForm.Street" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Number</label>
                                    <InputText class="form-control" @bind-Value="hospitalForm.Number" />
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" type="submit" disabled="@isHospitalFormBusy">
                                    @if (isHospitalFormBusy)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>@(hospitalForm.IsEdit ? "Saving..." : "Creating...")</span>
                                    }
                                    else if (hospitalForm.IsEdit)
                                    {
                                        <span><i class="bi bi-save me-2"></i>Update Hospital</span>
                                    }
                                    else
                                    {
                                        <span><i class="bi bi-plus-circle me-2"></i>Create Hospital</span>
                                    }
                                </button>
                                @if (hospitalForm.IsEdit)
                                {
                                    <button class="btn btn-outline-secondary" type="button" @onclick="CancelHospitalEdit" disabled="@isHospitalFormBusy">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </button>
                                }
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-people-fill me-2 text-success"></i>Your Hospital Memberships
                        </h5>

                        @if (!string.IsNullOrEmpty(membershipMessage))
                        {
                            <div class="alert alert-success py-2 mb-3">
                                <i class="bi bi-check-circle me-2"></i>@membershipMessage
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(membershipError))
                        {
                            <div class="alert alert-danger py-2 mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>@membershipError
                            </div>
                        }

                        @if (doctorHospitals.Count == 0)
                        {
                            <div class="alert alert-light border">
                                <i class="bi bi-info-circle me-2"></i>You are not a member of any hospital yet.
                            </div>
                        }
                        else
                        {
                            <div class="list-group mb-3">
                                @foreach (var hospital in doctorHospitals)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold">@hospital.Name</div>
                                            <div class="text-muted small">@FormatHospitalAddress(hospital)</div>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => BeginHospitalEdit(hospital)" disabled="@isHospitalFormBusy">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="async () => await LeaveHospital(hospital)" disabled="@isMembershipBusy">
                                                @if (isMembershipBusy && membershipActionHospitalId == hospital.Id)
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-box-arrow-right"></i>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <h6 class="fw-semibold mb-2">
                            <i class="bi bi-search me-2 text-success"></i>Find hospitals to join
                        </h6>
                        <div class="input-group mb-3">
                            <InputText class="form-control" placeholder="Search by name, city or county" @bind-Value="joinSearchTerm" />
                            <button class="btn btn-outline-success" type="button" @onclick="SearchHospitalsToJoin" disabled="@joinSearchBusy">
                                @if (joinSearchBusy)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                }
                                else
                                {
                                    <i class="bi bi-search"></i>
                                }
                            </button>
                        </div>
                        <div class="list-group">
                            @if (joinSearchResults.Count == 0)
                            {
                                <div class="text-muted small">
                                    Enter a keyword to search for hospitals you can join.
                                </div>
                            }
                            else
                            {
                                @foreach (var hospital in joinSearchResults)
                                {
                                    bool alreadyJoined = doctorHospitals.Any(h => h.Id == hospital.Id);
                                    <div @key="hospital.Id" class="list-group-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold">@hospital.Name</div>
                                            <div class="text-muted small">@FormatHospitalAddress(hospital)</div>
                                        </div>
                                        <button class="@(alreadyJoined ? "btn btn-sm btn-success" : "btn btn-sm btn-outline-success btn-join")"
                                                type="button"
                                                role="button"
                                                tabindex="0"
                                                @onclick="() => JoinHospitalClicked(hospital.Id, hospital.Name)"
                                                @onclick:preventDefault="true"
                                                @onclick:stopPropagation="true"
                                                disabled="@(alreadyJoined || isMembershipBusy ? true : null)">
                                            @if (alreadyJoined)
                                            {
                                                <span><i class="bi bi-check2-circle me-1"></i> Joined</span>
                                            }
                                            else if (isMembershipBusy && membershipActionHospitalId == hospital.Id)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                            }
                                            else
                                            {
                                                <span><i class="bi bi-plus-circle me-1"></i> Join</span>
                                            }
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private int? doctorUserId;
    private DoctorProfile? doctorProfile;

    private HospitalFormModel hospitalForm = new();
    private List<Hospital> doctorHospitals = new();
    private bool isHospitalSectionLoading = true;
    private bool isHospitalFormBusy;
    private string? hospitalFormMessage;
    private string? hospitalFormError;

    private bool isMembershipBusy;
    private int? membershipActionHospitalId;
    private string? membershipMessage;
    private string? membershipError;

    private List<Hospital> joinSearchResults = new();
    private string joinSearchTerm = string.Empty;
    private bool joinSearchBusy;

    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Prefer Blazor AuthenticationState over HttpContextAccessor for interactive reliability
        ClaimsPrincipal principal;
        if (AuthStateTask != null)
        {
            var authState = await AuthStateTask;
            principal = authState.User;
        }
        else
        {
            principal = HttpContextAccessor.HttpContext?.User ?? new ClaimsPrincipal(new ClaimsIdentity());
        }

        doctorUserId = Auth.GetUserId(principal);

        if (doctorUserId.HasValue)
        {
            var doctorAccount = await PatientService.GetByIdAsync(doctorUserId.Value);
            doctorProfile = doctorAccount?.DoctorProfile;
            await LoadDoctorHospitalsAsync();
        }

        isHospitalSectionLoading = false;
    }

    private async Task SaveHospital()
    {
        if (!doctorUserId.HasValue)
        {
            hospitalFormError = "Doctor identity not available.";
            return;
        }

        hospitalFormMessage = null;
        hospitalFormError = null;

        try
        {
            isHospitalFormBusy = true;
            var hospital = new Hospital
            {
                Id = hospitalForm.Id,
                Name = hospitalForm.Name.Trim(),
                Country = NormalizeOrNull(hospitalForm.Country),
                County = NormalizeOrNull(hospitalForm.County),
                City = NormalizeOrNull(hospitalForm.City),
                Street = NormalizeOrNull(hospitalForm.Street),
                Number = NormalizeOrNull(hospitalForm.Number)
            };

            if (hospitalForm.IsEdit && hospitalForm.Id > 0)
            {
                await HospitalService.UpdateHospitalAsync(doctorUserId.Value, hospital);
                hospitalFormMessage = "Hospital updated successfully.";
            }
            else
            {
                await HospitalService.CreateHospitalAsync(doctorUserId.Value, hospital);
                hospitalFormMessage = "Hospital created successfully. Join it from the list below when you are ready.";
            }

            await LoadDoctorHospitalsAsync();
            ResetHospitalForm();
        }
        catch (Exception)
        {
            hospitalFormError = "We couldn't save the hospital. Please try again.";
        }
        finally
        {
            isHospitalFormBusy = false;
        }
    }

    private void BeginHospitalEdit(Hospital hospital)
    {
        hospitalFormError = null;
        hospitalFormMessage = null;
        hospitalForm = new HospitalFormModel
        {
            Id = hospital.Id,
            IsEdit = true,
            Name = hospital.Name,
            Country = hospital.Country,
            County = hospital.County,
            City = hospital.City,
            Street = hospital.Street,
            Number = hospital.Number
        };
    }

    private void CancelHospitalEdit()
    {
        ResetHospitalForm();
    }

    private void ResetHospitalForm()
    {
        hospitalForm = new HospitalFormModel();
    }

    private async Task LoadDoctorHospitalsAsync()
    {
        if (!doctorUserId.HasValue)
        {
            doctorHospitals = new List<Hospital>();
            return;
        }

        doctorHospitals = (await HospitalService.GetHospitalsForDoctorAsync(doctorUserId.Value)).ToList();
    }

    private async Task LeaveHospital(Hospital hospital)
    {
        if (!doctorUserId.HasValue)
        {
            return;
        }

        membershipMessage = null;
        membershipError = null;

        try
        {
            isMembershipBusy = true;
            membershipActionHospitalId = hospital.Id;
            await HospitalService.LeaveHospitalAsync(doctorUserId.Value, hospital.Id);
            membershipMessage = $"You left {hospital.Name}.";
            await LoadDoctorHospitalsAsync();
        }
        catch (Exception)
        {
            membershipError = "We couldn't remove you from the hospital. Please try again.";
        }
        finally
        {
            isMembershipBusy = false;
            membershipActionHospitalId = null;
        }
    }

    private async Task JoinHospital(Hospital hospital)
    {
        if (!doctorUserId.HasValue)
        {
            return;
        }

        membershipMessage = null;
        membershipError = null;

        try
        {
            isMembershipBusy = true;
            membershipActionHospitalId = hospital.Id;
            await HospitalService.JoinHospitalAsync(doctorUserId.Value, hospital.Id);
            membershipMessage = $"You joined {hospital.Name}.";
            await LoadDoctorHospitalsAsync();
        }
        catch (Exception ex)
        {
            membershipError = $"We couldn't add you to the hospital. {ex.Message}";
        }
        finally
        {
            isMembershipBusy = false;
            membershipActionHospitalId = null;
            StateHasChanged(); // ensure UI refresh after async operation
        }
    }

    private async Task JoinHospitalClicked(int hospitalId, string hospitalName)
    {
        if (!doctorUserId.HasValue)
        {
            membershipError = "Doctor identity not available.";
            return;
        }

        membershipMessage = null;
        membershipError = null;

        try
        {
            isMembershipBusy = true;
            membershipActionHospitalId = hospitalId;
            await HospitalService.JoinHospitalAsync(doctorUserId.Value, hospitalId);
            membershipMessage = $"You joined {hospitalName}.";
            await LoadDoctorHospitalsAsync();
        }
        catch (Exception ex)
        {
            membershipError = $"We couldn't add you to the hospital. {ex.Message}";
        }
        finally
        {
            isMembershipBusy = false;
            membershipActionHospitalId = null;
        }
    }

    private async Task SearchHospitalsToJoin()
    {
        membershipError = null;

        try
        {
            joinSearchBusy = true;
            joinSearchResults = (await HospitalService.SearchHospitalsAsync(joinSearchTerm, maxResults: 50)).ToList();
        }
        catch (Exception)
        {
            membershipError = "We couldn't search hospitals right now. Please try again.";
        }
        finally
        {
            joinSearchBusy = false;
        }
    }

    private static string? NormalizeOrNull(string? value)
    {
        return string.IsNullOrWhiteSpace(value) ? null : value.Trim();
    }

    private static string FormatHospitalAddress(Hospital hospital)
    {
        var parts = new[] { hospital.Street, hospital.Number, hospital.City, hospital.County, hospital.Country }
            .Where(p => !string.IsNullOrWhiteSpace(p));
        return string.Join(", ", parts);
    }

    private class HospitalFormModel
    {
        public int Id { get; set; }
        public bool IsEdit { get; set; }
        [Required, MaxLength(200)]
        public string Name { get; set; } = string.Empty;
        [MaxLength(100)]
        public string? Country { get; set; }
        [MaxLength(100)]
        public string? County { get; set; }
        [MaxLength(100)]
        public string? City { get; set; }
        [MaxLength(150)]
        public string? Street { get; set; }
        [MaxLength(20)]
        public string? Number { get; set; }
    }
}
